<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600986 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="426"/>

<div>
<span><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">一、负载均衡</span></font></div><div><span style="font-size: 12pt;">1.1</span><span style="font-size: 12pt; font-weight: bold;">配置</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>http{</div><div>    #负载均衡服务器列表(tomcat)，自定义名称</div><div>    upstream myserver{</div><div>        ip_hash;</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">               server   115.28.52.63:8081 weight=1; </span> #weight代表权重，默认为1，越高被分配的客户端数量越多</div><div>        server 115.28.52.63:8081 weight=1;</div><div>    }</div><div>    server {</div><div>        listen 80;</div><div>        server_name 192.168.17.129;</div><div>        localtion / {</div><div>            proxy_pass http://myserver;</div><div>            proxy_connect_timeout 10;</div><div>        }</div><div>    }</div><div>}</div></div><div><span style="font-size: 12pt;">1.2</span><span style="font-size: 12pt; font-weight: bold;">策略</span>（配置在upstream内部）</div><div><span style="font-size: 10pt;">1.2.1默认轮询</span><span style="font-size: 12pt;">（</span>时间顺序逐一分配）</div><div>1.2.2当配置weight时，会指定轮询机率，主要用于处理不同服务器性能问题，weight大小与服务器性能成正比。</div><div>1.2.3.hash方式，可以解决session共享问题</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>upstream myserver{</div><div>    ip_hash;</div><div>    server   115.28.52.63:8081 weight=1;  #weight代表权重，默认为1，越高被分配的客户端数量越多</div><div>    server 115.28.52.63:8081 weight=1;</div><div>}</div></div><div>1.2.4.fair（第三方）：根据后端服务器响应时间分配</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>upstream myserver{</div><div>    fair;</div><div>    server   115.28.52.63:8081 weight=1;  #weight代表权重，默认为1，越高被分配的客户端数量越多</div><div>    server 115.28.52.63:8081 weight=1;</div><div>}</div></div><div><br/></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">二、nginx动静分离</span></font></div><div><span style="font-size: 12pt;">2.1</span><span style="font-size: 12pt; font-weight: bold;">实现方式</span></div><div>①静态资源单独部署，动态资源也单独部署，然后使用nginx进行域名转发（推荐）</div><div>②静态和动态资源混合在一起发布，通过nginx来实现分开，主要通过访问后缀名的方式实现分离，可设置expires来指定浏览器缓存过期时间。</div><div><br/></div><div><span style="font-size: 16pt; font-weight: bold;">三、root和alias的区别</span></div><div>root的处理结果是：root路径 ＋ location路径</div><div>alias的处理结果是：使用alias路径替换location路径</div><div>alias是一个目录别名的定义，root则是最上层目录的定义。</div><div>还有一个重要的区别是alias后面必须要用“/”结束，否则会找不到文件的，而root则可有可无。</div><div><br/></div><div><span style="font-size: 16pt; font-weight: bold;">四、nginx高可用集群</span></div><div><span style="font-size: 10pt;">向外提供一个虚拟ip，该虚拟ip负责转发主从nginx服务器，使用keepalived脚本工具检测nginx是否宕机</span></div><div><span style="font-size: 10pt;"><br/></span></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">五、跨域问题</span></font></div><div><font style="font-size: 14pt;">5.1</font> <font style="font-size: 12pt;">预请求过程</font></div><div><span style="font-size: 12pt;"><img src="Nginx_files/Image.png" type="image/png" data-filename="Image.png" width="783"/></span></div><div><font style="font-size: 12pt;"><br/></font></div><div>踩坑1：如果使用nginx做tomcat后端请求转发并配置了跨域，则java中不需要开启跨域，否则会出现双端*，*问题</div><div>跨域问题1：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">Access to XMLHttpRequest at</span> 'http://183.2.168.126:19899/altizure/floor/getAll' <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">from origin</span> 'http://183.2.168.126:8082' <span style="background-color: rgb(255, 250, 165);-evernote-highlight:true;">has been blocked by CORS policy:</span> Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.</div></div><div>踩坑排错2：前端请求数据的方式有误，content-type：……</div><div>解决方法：</div><div>一、前端配置代理</div><div><span>    </span><span>    </span><span>    </span><span>    </span><span> </span><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>//vue3.0的vue.config.js中配置</div><div>module.exports = {</div><div>  publicPath: './',</div><div>  devServer:{</div><div>    proxy: {</div><div>      '/altizure':{</div><div>        target: 'http://183.2.168.126:19899/',</div><div>        ws: false, // 如果需要，则配置websocket跨域为true</div><div>        secure: false, // 如果需要，则配置https接口为true</div><div>        changeOrigin: true, //是否跨域</div><div>        pathRewrite: {</div><div>          '^/altizure':'/altizure'</div><div>        }</div><div>      }</div><div>    }</div><div>  }</div><div>}</div><div><br/></div><div>//api.js中前缀为:</div><div><span>    </span>/altizure</div></div><div> 二、后端开启跨域controller添加注解@CrossOrigin</div><div><br/></div><div>跨域问题2：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>Response to preflight request doesn't pass access control check: No 'Access-Control-Allow-Origin' header is present on the requested resource.</div></div><div><font style="font-size: 16pt;"><span style="font-size: 16pt; font-weight: bold;">六、docker</span></font></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">配置文件：/etc/nginx/nginx.conf</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">配置目录: /etc/nginx/conf.d</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">静态文件目录：/usr/share/nginx/html</span></div><div><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;, &quot;SF Pro Display&quot;, Roboto, Noto, Arial, &quot;PingFang SC&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: common-ligatures;">日志目录：/var/log/nginx</span></div><div><span style="font-size: 12pt; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">docker run --name nginx-rtmp --restart always -p 18080:80 -p 1935:1935 -v /etc/nginx/nginx.conf:/etc/nginx/nginx.conf -v /etc/nginx/conf.d:/etc/nginx/conf.d -v /usr/share/nginx/html:/usr/share/nginx/html -v /var/log/nginx:/var/log/nginx -d </span><span style="font-size: 12pt; color: rgb(77, 77, 77); font-family: &quot;Microsoft YaHei&quot;;">alfg/nginx-rtmp</span></div></span>
</div></body></html> 